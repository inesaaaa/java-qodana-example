version: 2.1

executors:
  default:
    docker:
      - image: cimg/openjdk:17.0  # Use a Java Docker image for Maven builds
        auth:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_PASSWORD

jobs:
  build-and-check:
    executor: default
    steps:
      - checkout

      # Step 1: Fix Docker installation by addressing containerd conflict
      - run:
          name: Install Docker CLI
          command: |
            # Remove any conflicting containerd package
            sudo apt-get remove -y containerd 

            # Update the package list
            sudo apt-get update -y
            
            # Install Docker prerequisites
            sudo apt-get install -y \
              apt-transport-https \
              ca-certificates \
              curl \
              software-properties-common

            # Add Docker's official GPG key and repo
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
            echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

            # Update the package list with Docker's repo
            sudo apt-get update -y

            # Install Docker CLI and related tools
            sudo apt-get install -y docker-ce docker-ce-cli containerd.io

      - setup_remote_docker:
          version: default

      # Step 2: Build and run tests with Maven
      - run:
          name: Build and Test Project
          command: mvn clean test

      # Step 3: Run Qodana Static Analysis, Cloud Report
      - run:
          name: Run Qodana
          command: |
            docker run --rm \
              -v "$(pwd):/data/project" \
              -e QODANA_TOKEN=$QODANA_TOKEN \
              jetbrains/qodana-jvm:latest \
              --upload-result

# Define workflow to run the job
workflows:
  version: 2
  build-and-check-workflow:
    jobs:
      - build-and-check